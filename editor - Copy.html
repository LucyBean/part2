<!DOCTYPE html>
<html>

<head>

<title>Lucy's Part II Project</title>
<!-- skulpt -->
<script src="./skulpt/support/closure-library/closure/goog/base.js" type="text/javascript"></script>
<script src="./skulpt/src/env.js" type="text/javascript"></script>
<script src="./skulpt/src/parser.js" type="text/javascript"></script>
<script src="./skulpt/src/tokenize.js" type="text/javascript"></script>
<script src="./skulpt/src/symtable.js" type="text/javascript"></script>
<script src="./skulpt/src/compile.js" type="text/javascript"></script>
<script src="./skulpt/gen/parse_tables.js" type="text/javascript"></script>
<script src="./skulpt/gen/astnodes.js" type="text/javascript"></script>
<script src="./skulpt/src/ast.js" type="text/javascript"></script>
<script src="./skulpt/src/misceval.js" type="text/javascript"></script>
<script src="./skulpt/src/type.js" type="text/javascript"></script>
<script src="./skulpt/src/builtin.js" type="text/javascript"></script>
<script src="./skulpt/src/abstract.js" type="text/javascript"></script>
<script src="./skulpt/src/object.js" type="text/javascript"></script>
<script src="./skulpt/src/function.js" type="text/javascript"></script>
<script src="./skulpt/src/seqtype.js" type="text/javascript"></script>
<script src="./skulpt/src/numtype.js" type="text/javascript"></script>
<script src="./skulpt/src/list.js" type="text/javascript"></script>
<script src="./skulpt/src/tuple.js" type="text/javascript"></script>
<script src="./skulpt/src/module.js" type="text/javascript"></script>
<script src="./skulpt/src/int.js" type="text/javascript"></script>
<script src="./skulpt/src/bool.js" type="text/javascript"></script>
<script src="./skulpt/src/str.js" type="text/javascript"></script>
<script src="./skulpt/src/dict.js" type="text/javascript"></script>
<script src="./skulpt/src/errors.js" type="text/javascript"></script>

<script src="./skulpt/src/enumerate.js" type="text/javascript"></script>
<script src="./skulpt/src/set.js" type="text/javascript"></script>
<script src="./skulpt/src/slice.js" type="text/javascript"></script>
<script src="./skulpt/src/method.js" type="text/javascript"></script>
<script src="./skulpt/src/structseq.js" type="text/javascript"></script>

<script src="./skulpt/src/sorted.js" type="text/javascript"></script>
<script src="./skulpt/src/timsort.js" type="text/javascript"></script>

<script src="./skulpt/src/file.js" type="text/javascript"></script>

<script src="./skulpt/src/native.js" type="text/javascript"></script>
<script src="./skulpt/src/ffi.js" type="text/javascript"></script>
<script src="./skulpt/src/generator.js" type="text/javascript"></script>
<script src="./skulpt/src/fromcodepoint.js" type="text/javascript"></script>

<script src="./skulpt/src/complex.js" type="text/javascript"></script>
<script src="./skulpt/src/biginteger.js" type="text/javascript"></script>
<script src="./skulpt/src/long.js" type="text/javascript"></script>
<script src="./skulpt/src/float.js" type="text/javascript"></script>
<script src="./skulpt/src/constants.js" type="text/javascript"></script>

<script src="./skulpt/src/formatting.js" type="text/javascript"></script>
<script src="./skulpt/src/print.js" type="text/javascript"></script>
<script src="./skulpt/src/builtindict.js" type="text/javascript"></script>
<script src="./skulpt/src/import.js" type="text/javascript"></script>

<script src="skulpt/skulpt-stdlib.js" type="text/javascript"></script>
<script src="skulpt/src/lib/turtle.js" type="text/javascript"></script>

<!-- My stuff -->
<script src="./mySrc/formattedOutput.js" type="text/javascript"></script>
<script src="./mySrc/myadditions.js" type="text/javascript"></script>
<script src="./mySrc/drawing.js" type="text/javascript"></script>
<script src="./mySrc/ilabelMeaning.js" type="text/javascript"></script>
<script src="./mySrc/debug.js" type="text/javascript"></script>
<script src="./mySrc/fix.js" type="text/javascript"></script>
<script src="./mySrc/help.js" type="text/javascript"></script>
<script src="./mySrc/parseTrees.js" type="text/javascript"></script>
<script src="./mySrc/find.js" type="text/javascript"></script>
<script src="./mySrc/logger.js" type="text/javascript"></script>
<script src="./turtle/turtleTasks.js" type="text/javascript"></script>

<!-- CodeMirror -->
<script src="./codemirror/codemirror.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/selection/active-line.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/edit/matchbrackets.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/edit/closebrackets.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/hint/show-hint.js" type="text/javascript"></script>

<link rel="stylesheet" href="codemirror/codemirror.css">
<script src="codemirror/python.js" type="text/javascript"></script>

<!-- Fabric.js -->
<script src="./fabric/dist/fabric.js" type="text/javascript"></script>

<!-- FileSaver -->
<script src="./FileSaver.js/FileSaver.js" type="text/javascript"></script>

<style type="text/css">
td.newStyle1 {
	margin: 5px;
	padding: 10px;
	background-color: #9999FF;
	vertical-align: top;
	text-align: left;
}
body {
	font-family: "Segoe UI";
}
h1 {
	font-size: 18px;
}
.rightMenuStyle {
	background-color:#CDDEFE;
	width:390px;
	padding:5px;
}
.codeStyle {
	font-family:"Consolas";
	padding:1px;
	background-color:#CCFFCC;
}
span.codeStyle {
	line-height: 1.8;
	border-style:solid;
	border-width:1px;
}
</style>
</head>

<body>

<table style="width: 100%; height:100%">
	<tr>
		<td colspan="4">&nbsp;</td>
	</tr>
	<tr>
		<td rowspan="2">&nbsp;</td>
		<td class="newStyle1" style="width: 600px; height:600px;">
			<div id="codeWindow" style="width: 600px; height:600px;">
				<textarea id="yourCode">(5+)</textarea>
			</div>
			<div id="turtleWindow" style="display:none; width:600px; height:295px;">
				<div id="errCanvasDiv" style="display:none; overflow:auto; overflow-y:auto; width:100%; height:100%; background-color:white;">
					<canvas id="errCanvas"></canvas>
				</div>
				<div id="turtleCanvas" style="width:600px; height:295px; background-color:white;">
				</div>
			</div>
		</td>
		<td class="newStyle1" style="width: 400px" rowspan="2">
			<div id="welcome" class="rightMenuStyle" style="height:300px;">
				<h1>Welcome to my project.</h1>
				<p>My project is looking at how syntax errors can be improved in order to help novice programmers.
				</p>
			</div>
			<div id="taskWindow" class="rightMenuStyle" style="height:300px; display:none">
				<h1>Tasks</h1>
				<div id="taskText" style="height:250px; overflow-y:auto">Select 
					a task to complete by clicking on one of the numbers below 
					the main panel.</div>
			</div>
			<div style="height:8px"></div>
			<div id="results" class="rightMenuStyle" style="height:370px">
				<h1>Results</h1>
				<div id="resultDisplay" class="codeStyle" style="overflow-y:auto;">
				After you hit the run button, the results of your code will appear here.
				</div>
			</div>
			<div id="errorDisplay" class="rightMenuStyle" style="height:370px; display:none; overflow-y:auto;">
				<h1>Oh no! Looks like you had some errors...</h1>
				<div id="errorOutput">Help for errors will appear here.</div>
			</div>
		</td>
		<td rowspan="2">&nbsp;</td>
	</tr>
	<tr>
		<td class="newStyle1" style="width: 600px; height:75px; padding:0px;">
		<table>
			<tr>
				<td>
					<img alt="Run code button" title="Run the code and see results!" height="75" src="img/btn-run-unpressed.png" width="75" onclick="run()">			
					<img alt="Display Turtle" title="Show/hide the turtle panel." height="75" src="img/btn-turtle-unpressed.png" width="75" onclick="toggleTurtle()">
				</td>
				<td style="width:20px"></td>
				<td>
					<img alt="Tasks" height="75" src="img/tasks.png" width="30">
				</td>
				<td title="Load the starting text for each task.">
					<img alt="Task 1" height="50" src="img/btn-1-unpressed.png" width="50" onclick="loadTask(1)">
					<img alt="Task 2" height="50" src="img/btn-2-unpressed.png" width="50" onclick="loadTask(2)">
					<img alt="Task 3" height="50" src="img/btn-3-unpressed.png" width="50" onclick="loadTask(3)">
				</td>
				<td style="width:20px"></td>
				<td>
					<img alt="Undo" height="50" width="50" src="img/btn-undo.png" onclick="myCodeMirror.undo()">
					<img alt="Redo" height="50" width="50" src="img/btn-redo.png" onclick="myCodeMirror.redo()">
					<img alt="Save log" height="50" width="50" src="img/btn-save.png" onclick="Logger.save()">
				</td>
			</tr>
		</table>
		</td>
	</tr>
	<tr>
		<td colspan="4">&nbsp;</td>
	</tr>
</table>

<script type="text/javascript">
var resultsPage = document.getElementById("results");
var ecd = document.getElementById("errCanvasDiv");
var tc = document.getElementById("turtleCanvas");

var displayResultsPane = function () {
	resultsPage.style.display = "block";
	errorDisplay.style.display = "none";
}

var displayErrorPane = function () {
	resultsPage.style.display = "none";
	errorDisplay.style.display = "block";
	
	displayTurtle();
	// Hide the turtle canvas and show the err canvas
	ecd.style.display = "block";
	tc.style.display = "none";
}

var displayWelcome = function () {
	var welcome = document.getElementById("welcome");
	var taskWindow = document.getElementById("taskWindow");
	
	welcome.style.display = "block";
	taskWindow.style.display = "none";
}

var displayTasks = function () {
	var welcome = document.getElementById("welcome");
	var taskWindow = document.getElementById("taskWindow");
	
	welcome.style.display = "none";
	taskWindow.style.display = "block";
}

var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("yourCode"), {
		lineNumbers: true,
		indentUnit: 4,
		styleActiveLine: true,
		matchBrackets: true,
		autoCloseBrackets: true
	});
	
myCodeMirror.setSize(600, 600);

var replaceLine = function (lineNum, replacement, tokensToBeReplaced) {
	// Replace all tokensToBeReplaced using prompts
	var ttbr = tokensToBeReplaced;
	var last = 0;
	var newString = ""
	for (i in ttbr) {
		var slice = replacement.slice(last, ttbr[i].start);
		last = ttbr[i].end;
		var r = prompt("Please enter a value for " + ttbr[i].prompt + ".\nDo not include square brackets.");
		newString += slice + r;
	}
	newString += replacement.slice(last);
	replacement = newString;

	var cur = myCodeMirror.getLine();
	// Extract and replace the required line
	var text = myCodeMirror.getValue();
	var lines = Sk.help.splitToLines(text);
	lines[lineNum-1] = replacement;
	
	// Join the lines back again
	var text = "";
	for (var i = 0; i < lines.length; i++) {
		text += lines[i];
		
		if (i !== lines.length-1) {
			text += "\n";
		}
	}
	Logger.log("Replacement chosen","line " + lineNum + " " + escape(replacement), text);
	myCodeMirror.setValue(text);
	myCodeMirror.setCursor(cur,0);
};

var turtleDisplayed = false;

var displayTurtle = function () {
	turtleDisplayed = true;
	var codeWindow = document.getElementById("codeWindow");
	var turtleWindow = document.getElementById("turtleWindow");
	myCodeMirror.setSize(600, 290);
	codeWindow.style.height = "300px";
	turtleWindow.style.display = "block";
}

var hideTurtle = function () {
	turtleDisplayed = false;
	var codeWindow = document.getElementById("codeWindow");
	var turtleWindow = document.getElementById("turtleWindow");
	myCodeMirror.setSize(600, 600);
	codeWindow.style.height = "600px";
	turtleWindow.style.display = "none";
}

var toggleTurtle = function () {
	if (!turtleDisplayed) {
		displayTurtle();

	} else {
		hideTurtle();
	}
}

var loadTask = function (n) {
	displayTasks();
	
	var task = Sk.turtleTasks[n];
	
	if (task) {
		taskText.innerHTML = task.promptText;
		myCodeMirror.setValue(task.initCode);
	}
}

var errCanvas = new fabric.Canvas("errCanvas");
errCanvas.setWidth(600);
errCanvas.setHeight(300);
errCanvas.backgroundColor = "white";
errCanvas.renderAll();

var output = document.getElementById("resultDisplay");
var errOut = document.getElementById("errorOutput");
var taskText = document.getElementById("taskText");
Sk.formattedOutput.setOutputs({err:errOut, errCanvas:errCanvas, taskList:taskText, codeMirror:myCodeMirror, lineReplace:replaceLine});

var codeOutput = function (text) {
	output.innerHTML += text;
}
var builtinRead = function(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
}
var debugOut = function(arg) {
	var debug = true;
	if (debug) {
		console.log(arg);
	}
}

var askName = function() {
	var name = prompt("Please enter your logging number.");
	Logger.setName(name);
};

askName();

var run = function () {
	displayResultsPane();
	displayTurtle();
	myCodeMirror.save();
	var prog = document.getElementById("yourCode").value;
	
	// Display the turtle automatically if the first line of
	// the program is "import turtle"
	var firstLine = Sk.help.splitToLines(prog);
	if (firstLine.indexOf("import turtle") === -1) {
		hideTurtle();
	}
	else {
		displayTurtle();
	}
	
	output.innerHTML = "";
	errOut.innerHTML = "";
	errCanvas.clear();
	Sk.formattedOutput.reset();
	
	// Hide the err canvas and show the turtle
	tc.style.display = "block";
	ecd.style.display = "none";
	
	var turtleCanvas = document.getElementById("turtleCanvas");
	
	(Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = "turtleCanvas";
	Sk.configure({output:codeOutput, read:builtinRead, debugout:debugOut});

	if (prog !== "") {
		try {
			var result = Sk.importMainWithBody("<stdin>", false, prog, true);
		   
			var myPromise = Sk.misceval.asyncToPromise(function() {
				return result;
			});
		   
			myPromise.then(function(mod) {Logger.log("Success","none",prog);},	function(err) {Logger.log("Error","Unfixable",prog); displayErrorPane(); Sk.formattedOutput.unfixableErr(err);});
		}
		catch (err) {
			displayErrorPane();
			if (err === "Incorrect syntax")	{
				Logger.log("Error","Suggestions made",prog);
				console.log("Syntax was incorrect, but a fix was attempted.");
			}
			else {
				Logger.log("Error","Unfixable",prog);
				console.log(err);
				Sk.formattedOutput.unfixableErr(err);
				throw err;
			}
		}
	}
}
</script>


</body>

</html>
