<!DOCTYPE html>
<html>

<head>

<title>Lucy's Part II Project</title>
<!-- skulpt -->
<script src="./skulpt/support/closure-library/closure/goog/base.js" type="text/javascript"></script>
<script src="./skulpt/src/env.js" type="text/javascript"></script>
<script src="./skulpt/src/parser.js" type="text/javascript"></script>
<script src="./skulpt/src/tokenize.js" type="text/javascript"></script>
<script src="./skulpt/src/symtable.js" type="text/javascript"></script>
<script src="./skulpt/src/compile.js" type="text/javascript"></script>
<script src="./skulpt/gen/parse_tables.js" type="text/javascript"></script>
<script src="./skulpt/gen/astnodes.js" type="text/javascript"></script>
<script src="./skulpt/src/ast.js" type="text/javascript"></script>
<script src="./skulpt/src/misceval.js" type="text/javascript"></script>
<script src="./skulpt/src/type.js" type="text/javascript"></script>
<script src="./skulpt/src/builtin.js" type="text/javascript"></script>
<script src="./skulpt/src/abstract.js" type="text/javascript"></script>
<script src="./skulpt/src/object.js" type="text/javascript"></script>
<script src="./skulpt/src/function.js" type="text/javascript"></script>
<script src="./skulpt/src/seqtype.js" type="text/javascript"></script>
<script src="./skulpt/src/numtype.js" type="text/javascript"></script>
<script src="./skulpt/src/list.js" type="text/javascript"></script>
<script src="./skulpt/src/tuple.js" type="text/javascript"></script>
<script src="./skulpt/src/module.js" type="text/javascript"></script>
<script src="./skulpt/src/int.js" type="text/javascript"></script>
<script src="./skulpt/src/bool.js" type="text/javascript"></script>
<script src="./skulpt/src/str.js" type="text/javascript"></script>
<script src="./skulpt/src/dict.js" type="text/javascript"></script>
<script src="./skulpt/src/errors.js" type="text/javascript"></script>

<script src="./skulpt/src/enumerate.js" type="text/javascript"></script>
<script src="./skulpt/src/set.js" type="text/javascript"></script>
<script src="./skulpt/src/slice.js" type="text/javascript"></script>
<script src="./skulpt/src/method.js" type="text/javascript"></script>
<script src="./skulpt/src/structseq.js" type="text/javascript"></script>

<script src="./skulpt/src/sorted.js" type="text/javascript"></script>
<script src="./skulpt/src/timsort.js" type="text/javascript"></script>

<script src="./skulpt/src/file.js" type="text/javascript"></script>

<script src="./skulpt/src/native.js" type="text/javascript"></script>
<script src="./skulpt/src/ffi.js" type="text/javascript"></script>
<script src="./skulpt/src/generator.js" type="text/javascript"></script>
<script src="./skulpt/src/fromcodepoint.js" type="text/javascript"></script>

<script src="./skulpt/src/complex.js" type="text/javascript"></script>
<script src="./skulpt/src/biginteger.js" type="text/javascript"></script>
<script src="./skulpt/src/long.js" type="text/javascript"></script>
<script src="./skulpt/src/float.js" type="text/javascript"></script>
<script src="./skulpt/src/constants.js" type="text/javascript"></script>

<script src="./skulpt/src/formatting.js" type="text/javascript"></script>
<script src="./skulpt/src/print.js" type="text/javascript"></script>
<script src="./skulpt/src/builtindict.js" type="text/javascript"></script>
<script src="./skulpt/src/import.js" type="text/javascript"></script>

<script src="skulpt/skulpt-stdlib.js" type="text/javascript"></script>
<script src="skulpt/src/lib/turtle.js" type="text/javascript"></script>

<!-- My stuff -->
<script src="./mySrc/formattedOutput.js" type="text/javascript"></script>
<script src="./mySrc/myadditions.js" type="text/javascript"></script>
<script src="./mySrc/drawing.js" type="text/javascript"></script>
<script src="./mySrc/ilabelMeaning.js" type="text/javascript"></script>
<script src="./mySrc/debug.js" type="text/javascript"></script>
<script src="./mySrc/fix.js" type="text/javascript"></script>
<script src="./mySrc/help.js" type="text/javascript"></script>
<script src="./mySrc/parseTrees.js" type="text/javascript"></script>
<script src="./mySrc/find.js" type="text/javascript"></script>
<script src="./mySrc/logger.js" type="text/javascript"></script>

<!-- CodeMirror -->
<script src="./codemirror/codemirror.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/selection/active-line.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/edit/matchbrackets.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/edit/closebrackets.js" type="text/javascript"></script>
<script src="./codemirror/codemirror-5.9/addon/hint/show-hint.js" type="text/javascript"></script>
<link rel="stylesheet" href="codemirror/codemirror.css">
<script src="codemirror/python.js" type="text/javascript"></script>

<!-- Fabric.js -->
<script src="./fabric/dist/fabric.js" type="text/javascript"></script>

<!-- FileSaver -->
<script src="./FileSaver.js/FileSaver.js" type="text/javascript"></script>

<style type="text/css">
* {
	box-sizing: border-box;
}
html {
	height:100%;
}
body {
	height:97%;
}
table.main td {
	margin: 5px;
	padding: 10px;
	background-color: #7777FF;
	vertical-align: top;
	text-align: left;
}
td.blank {
	background-color: #ffffff;
}
td > div {
	width: 100%;
	height: 100%;
	background-color: #cddefe;
	font-family:"Segoe UI";
}
.rightPanel > div {
	padding: 8px;
}
.rightPanel > div > div {
	background-color:#aaaaff;
	height:300px;
	overflow-y:auto;
}
div.turtle {
	background-color:white;
	width:1000px;
	height:400px;
	border:1px solid black;
	box-sizing: content-box;
}
span.heading {
	font-size: 24px;
	font-weight: bold;
}
.codeStyle {
	font-family:"Consolas";
}
button {
    background-color: #7777FF;
    border: 1px solid #9999ff;
	color: white;
	font-family:"Segoe UI";
    padding: 10px 16px;
	margin: 5px;
    text-align: center;
    text-decoration: none;
    font-size: 18px;
	-webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
}
button.codeStyle {
	text-align:left;
}
button:hover {
	background-color: #aaaaff;
}
/* The container div - needed to position the dropdown content */
.dropdown {
	z-index:100;
    position: relative;
    display: inline-block;
}
/* Dropdown Content (Hidden by Default) */
.dropdown-content {
    display: none;
    position: absolute;
    bottom: 100%;
    background-color: #f3f3f3;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
}
/* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
.show {display:block;}
</style>
</head>

<body onload="Logger.load()" onunload="Logger.store()">
	<table class="main" id="table" style="height:100%; width:100%">
		<tr id="mainPanel">
			<td>
				<div id="codeWindow" style="overflow:auto;">
					<textarea id="yourCode" style="width:100%; height:100%;"></textarea>
				</div>
			</td>
			<td class="rightPanel" style="width:400px;">
				<div id="welcomeDisplay">
					<span class="heading">Welcome to my project.</span>
					<p>My project is about improving syntax error usability for novice programmers.</p>
				</div>
				<div id="resultDisplay" style="display:none;">
					<span class="heading">Results</span>
					<p>Results of your code will appear here, if any.</p>
					<div id="output" style="overflow-y:auto;">
					</div>
				</div>
				<div id="errorDisplay" style="display:none;">
					<span class="heading">Your code had some errors</span>
					<div id="errOut" style="height:300px; overflow-y:auto;">
						Error messages will appear here.
					</div>
				</div>
				<div id="settingDisplay" style="display:none;">
					<span class="heading">Settings</span>
					<p>
						<input id="useTurtle" type="checkbox" checked>Use turtle<br/>
						<button onclick="Logger.reset()">Clear log</button>
					</p>
				</div>
			</td>
		</tr>
		<tr id="turtlePanel" style="display:none; height:50%">
			<td colspan="2">
				<div id="errCanvasDiv" style="overflow:auto; overflow-y:auto; display:none; background-color:white;">
					<canvas id="errCanvas"></canvas>
				</div>
				<div class="turtle" id="turtleCanvas">
				</div>
			</td>
		</tr>
		<tr id="menuPanel">
			<td style="height:75px;" colspan="2">
				<div>
					<button onclick="run()">Run</button>
					<button onclick="toggleTurtle()">Show/hide turtle</button>
					<button onclick="myCodeMirror.undo()">Undo</button>
					<button onclick="myCodeMirror.redo()">Redo</button>
					<div class="dropdown">
						<button onclick="myFunction()" class="dropbtn">Load task</button>
						<div id="myDropdown" class="dropdown-content">
							<button onclick="loadTask(0)">1</button>
							<button onclick="loadTask(1)">2</button>
					 		<button onclick="loadTask(2)">3</button>
					 		<button onclick="loadTask(3)">4</button>
						</div>
					</div>
					<button onclick="Logger.save()">Save log</button>
					<button onclick="displaySettings()">Settings</button>
				</div>
			</td>
		</tr>
	</table>
<script>
var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("yourCode"), {
		lineNumbers: true,
		indentUnit: 4,
		styleActiveLine: true,
		matchBrackets: true,
		autoCloseBrackets: true
	});
var ut = document.getElementById("useTurtle");

// Show/hide functions
var turtleDisplayed = false;
var showTurtle = function() {
	var turtlePanel = document.getElementById("turtlePanel");
	var mainPanel = document.getElementById("mainPanel");
	mainPanel.style.height = "300px";
	turtlePanel.style.display = "table-row";
	turtleDisplayed = true;
}
var hideTurtle = function() {
	var turtlePanel = document.getElementById("turtlePanel");
	var mainPanel = document.getElementById("mainPanel");
	turtlePanel.style.display = "none";
	turtleDisplayed = false;
}
var toggleTurtle = function() {
	if (turtleDisplayed) hideTurtle();
	else showTurtle();
}
var displayWelcome = function() {
	var wd = document.getElementById("welcomeDisplay");
	var rd = document.getElementById("resultDisplay");
	var ed = document.getElementById("errorDisplay");
	var sd = document.getElementById("settingDisplay");
	
	wd.style.display = "block";
	rd.style.display = "none";
	ed.style.display = "none";
	sd.style.display = "none";
}
var displayResults = function() {
	var wd = document.getElementById("welcomeDisplay");
	var rd = document.getElementById("resultDisplay");
	var ed = document.getElementById("errorDisplay");
	var sd = document.getElementById("settingDisplay");
	
	wd.style.display = "none";
	rd.style.display = "block";
	ed.style.display = "none";
	sd.style.display = "none";
}
var displayErrors = function() {
	var wd = document.getElementById("welcomeDisplay");
	var rd = document.getElementById("resultDisplay");
	var ed = document.getElementById("errorDisplay");
	var sd = document.getElementById("settingDisplay");
	var ecd = document.getElementById("errCanvasDiv");
	var tc = document.getElementById("turtleCanvas");
	
	ecd.style.display = "block";
	tc.style.display = "none";
	
	wd.style.display = "none";
	rd.style.display = "none";
	ed.style.display = "block";
	sd.style.display = "none";
	
	showTurtle();
}
var displaySettings = function() {
	var wd = document.getElementById("welcomeDisplay");
	var rd = document.getElementById("resultDisplay");
	var ed = document.getElementById("errorDisplay");
	var sd = document.getElementById("settingDisplay");
	
	wd.style.display = "none";
	rd.style.display = "none";
	ed.style.display = "none";
	sd.style.display = "block";
}
/* When the user clicks on the button, 
toggle between hiding and showing the dropdown content */
function myFunction() {
    document.getElementById("myDropdown").classList.toggle("show");
}
// Close the dropdown menu if the user clicks outside of it
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn')) {

    var dropdowns = document.getElementsByClassName("dropdown-content");
    var i;
    for (i = 0; i < dropdowns.length; i++) {
      var openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}

// Tasks
var loadTask = function (num) {

	var tasks = [
		"t.forward(100)\t\t# Go forward 100 units\nt.left(45)\t\t\t# Turn left 45 degrees\nt.forward(30)\t\t# Go forwards 30 units\n",
		"for i in range(6):\t# Repeat the following lines 6 times.\n\tt.forward(40)\n\tt.left(45)\n",
		"def drawSquare():\t\t# Define a new procedure, drawSquare\n\tfor i in range(4):\n\t\tt.forward(40)\n\t\tt.left(90)\n\ndrawSquare()\t\t\t# Call drawSquare\n",
		"from random import randint\n\nwhile True:\t\t\t\t\t# Infinite loop\n\tt.forward(20)\n\tangle = randint(-45,45)\t# ‘angle’ has a random value between -45 and 45\n\tt.left(angle)\n"
		];
	
	var t = tasks[num];
	if (t) {
		Logger.log("Loaded task",num);
		myCodeMirror.setValue(tasks[num]);
		ut.checked = true;
	}
}

// Replacement function
var replaceLine = function (lineNum, replacement, tokensToBeReplaced, log) {
	if (log === undefined) {
		log = true;
	}
	// Replace all tokensToBeReplaced using prompts
	var ttbr = tokensToBeReplaced;
	var last = 0;
	var newString = ""
	for (i in ttbr) {
		var slice = replacement.slice(last, ttbr[i].start);
		last = ttbr[i].end;
		var r = prompt("Please enter a value for " + ttbr[i].prompt + ".\nDo not include square brackets.");
		newString += slice + r;
	}
	newString += replacement.slice(last);
	replacement = newString;

	var cur = myCodeMirror.getLine();
	// Extract and replace the required line
	// Copy across any whitespace at the start of the line
	var text = myCodeMirror.getValue();
	var lines = Sk.help.splitToLines(text);
	var old = lines[lineNum-1];
	var whitespace = "";
	while (old[0] === " " || old[0] === "\t") {
		whitespace += old[0];
		old = old.slice(1);
	}
	lines[lineNum-1] = whitespace + replacement;
	
	// Join the lines back again
	var text = "";
	for (var i = 0; i < lines.length; i++) {
		text += lines[i];
		
		if (i !== lines.length-1) {
			text += "\n";
		}
	}
	if(log) Logger.log("Replacement chosen","line " + lineNum + " " + escape(replacement), text);
	myCodeMirror.setValue(text);
	try {
		myCodeMirror.setCursor(cur);
	}
	catch (err) {
		console.log(err);
	}
};
var mouseOverPrevTemp;

// Canvas stuff
var errCanvas = new fabric.Canvas("errCanvas");
errCanvas.backgroundColor = "white";
errCanvas.renderAll();
errCanvas.on('mouse:over', function(e) {
	var codePos = e.target.codePos;
	var selStart;
	var selEnd;
	if (codePos) {
		if (codePos.line < 0) {
			selStart = {line:Sk.formattedOutput.original.lineNum-1};
		}
		else {
			selStart = {line:codePos.line};
		}
		selStart.ch = codePos.ch;
		
		// If there is a valid code position, highlight it
		if (codePos.len > 0) {
			var selEnd = {line:selStart.line, ch:selStart.ch + codePos.len};	
			mouseOverPrevTemp = myCodeMirror.getValue();
			replaceLine(selStart.line+1, e.target.line, undefined, false);
			myCodeMirror.setSelection(selStart, selEnd);
		}
	}
});
errCanvas.on('mouse:out', function (e) {
	if (mouseOverPrevTemp) {
		var cur = myCodeMirror.getCursor();
		myCodeMirror.setValue(mouseOverPrevTemp);
		myCodeMirror.setCursor(cur);
		mouseOverPrevTemp = undefined;
	}
});

// Skulpt code
Sk.formattedOutput.setOutputs({err:document.getElementById("errOut"), errCanvas:errCanvas, codeMirror:myCodeMirror, lineReplace:replaceLine});
var codeOutput = function (text) {
	var output = document.getElementById("output");
	if (text === "\n") text = "<br/>";
	output.innerHTML += "<span class = \"codeStyle\">" + text + "</span>";
}
var builtinRead = function(x) {
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
            throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
}
var debugOut = function(arg) {
	var debug = true;
	if (debug) {
		console.log(arg);
	}
}
var runTimeErr = function (err) {
	Logger.log("Error","Run time.",prog);
	displayErrors();
	Sk.formattedOutput.unfixableErr(err);
}
var run = function () {
	var output = document.getElementById("output");
	var errOut = document.getElementById("errOut");
	displayResults();
	showTurtle();
	myCodeMirror.save();
	var prog = document.getElementById("yourCode").value;
	
	// Display the turtle if "Use turtle" setting is true or if there is an "import turtle" line
	// Also append turtle preamble code if necessary
	var lines = Sk.help.splitToLines(prog);
	if (lines.indexOf("import turtle") !== -1) {
		showTurtle();
	}
	else if (ut.checked) {
		showTurtle();
		prog = "import turtle\nt = turtle.Turtle()\n" + prog;
	}
	else {
		hideTurtle();
	}

	
	output.innerHTML = "";
	errOut.innerHTML = "";
	errCanvas.clear();
	Sk.formattedOutput.reset();
	
	// Hide the err canvas and show the turtle
	var tc = document.getElementById("turtleCanvas");
	tc.style.display = "block";
	document.getElementById("errCanvasDiv").style.display = "none";
	
	var turtleCanvas = document.getElementById("turtleCanvas");
	
	(Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = "turtleCanvas";
	Sk.configure({output:codeOutput, read:builtinRead, debugout:debugOut});

	if (prog !== "") {
		Logger.log("Running code","",prog);
		Logger.store();
		try {
			var result = Sk.importMainWithBody("<stdin>", false, prog, true);
		   
			var myPromise = Sk.misceval.asyncToPromise(function() {
				return result;
			});
		   
			myPromise.then(function(mod) {Logger.log("Success","none",prog);},	runTimeErr);
		}
		catch (err) {
			displayErrors();
			if (err === "Incorrect syntax")	{
				Logger.log("Error","Suggestions made.",prog);
				console.log("Syntax was incorrect, but a fix was attempted.");
			}
			else {
				Logger.log("Error","Unfixable syntax error.",prog);
				console.log(err);
				Sk.formattedOutput.unfixableErr(err);
				throw err;
			}
		}
	}
}
</script>
</body>

</html>
